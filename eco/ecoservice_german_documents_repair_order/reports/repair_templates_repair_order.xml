<?xml version="1.0" encoding="utf-8"?>
<!--
# Developed by ecoservice (Uwe BÃ¶ttcher und Falk Neubert GbR).
# See COPYRIGHT and LICENSE files at the root directory for full details.
-->
<odoo>

  <template id="report_repair_order_inherit" inherit_id="repair.report_repairorder2">
    <xpath expr="//t[@t-call='repair.report_repairorder']" position="attributes">
      <attribute name="t-if">False</attribute>
    </xpath>
    <xpath expr="//t[@t-call='repair.report_repairorder']" position="before">
      <t t-set="o" t-value="doc" />
      <t t-set="gd_active"
        t-value="doc.sudo().company_id.external_report_layout_id.key == 'ecoservice_german_documents_base.external_layout_german_documents'" />
      <t t-call="ecoservice_german_documents_repair_order.report_repair_order_document_inherit"
        t-lang="o.partner_id.get_lang()"
        t-if="gd_active" />
      <t t-call="repair.report_repairorder"
        t-lang="doc.partner_id.get_lang()"
        t-else="" />
    </xpath>
  </template>

  <template id="report_repair_order_document_inherit">
    <t t-call="web.external_layout">
      <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)" />
      <div class="row address_row">
        <div class="col-6">
          <t t-call="ecoservice_german_documents_base.letterhead_sender_address"/>
          <t t-call="ecoservice_german_documents_base.letterhead_receiver_address"/>
        </div>
        <div class="col-6">
          <t t-call="ecoservice_german_documents_repair_order.letterhead_reference_repair_order"/>
        </div>
      </div>
      <div class="page">
        <div class="oe_structure"/>
        <t t-call="ecoservice_german_documents_repair_order.repair_order_some_information"/>
        <t t-call="ecoservice_german_documents_repair_order.table_repair_order"/>
        <p class="mt32" t-field="o.quotation_notes"/>
        <!-- Css sytle-->
        <t t-call="ecoservice_german_documents_base.report_css_body"/>
        <t t-call="ecoservice_german_documents_repair_order.report_css_body_repair_order"/>
      </div>
    </t>
  </template>

  <template id="letterhead_reference_repair_order">
    <div id="letterhead_reference" class="row">
      <div>
        <t t-set="client_order_ref"
           t-value="o.name"/>
        <div class="doc-type ml10">
          <span t-if="o.state != 'draft'">Repair Order: </span>
          <span t-if="o.state == 'draft'">Repair Quotation: </span>
        </div>

        <!-- Customer No. & VAT references -->
        <t name="reference_customer_vat"
           t-call="ecoservice_german_documents_base.letterhead_reference_customer_vat"/>

        <!-- References about the case for the customer -->
        <t name="reference_case"
           t-call="ecoservice_german_documents_base.letterhead_reference_case"/>

        <!-- References about our company for the customer -->
        <t name="reference_contact"
           t-call="ecoservice_german_documents_base.letterhead_reference_contact"/>

        <!-- Details about our company -->
        <t name="reference_company"
           t-call="ecoservice_german_documents_base.letterhead_reference_company"/>
      </div>
    </div>
  </template>

  <template id="repair_order_some_information">
    <div id="informations" class="row mt32 mb32">
      <div t-if="o.product_id.name" class="col-3 bm-2">
        <strong>Product to Repair:</strong>
        <p t-field="o.product_id.name" class="m-0" />
      </div>
      <div class="col-3 bm-2" groups="stock.group_production_lot">
        <strong>Lot/Serial Number:</strong>
        <t t-if="o.lot_id">
          <span t-field="o.lot_id.name" />
        </t>
      </div>
      <div t-if="o.guarantee_limit" class="col-3 bm-2">
        <strong>Warranty:</strong>
        <p t-field="o.guarantee_limit" class="m-0" />
      </div>
      <div class="col-3 bm-2">
        <strong>Printing Date:</strong>
        <p t-esc="datetime.datetime.now().strftime('%Y-%m-%d')" t-options="{'widget': 'date'}"
          class="m-0" />
      </div>
      <div class="col-3 bm-2">
        <strong>Ticket:</strong>
        <span t-if="o.ticket_id">
          <br/>
          <t t-esc="o.ticket_id.name" /> (#<t t-esc="o.ticket_id.id" />)
        </span>
      </div>
    </div>
  </template>

  <template id="table_repair_order">
    <table class="table table-sm o_main_table">
      <thead>
        <tr>
          <th class="text-left">Description</th>
          <th class="text-end">Quantity</th>
          <t t-if="o.invoice_method != 'none'">
            <th class="text-end">Unit Price</th>
            <th class="text-center">Tax</th>
            <th class="text-end">Price</th>
          </t>
        </tr>
      </thead>
      <tbody>
        <t t-if="o.operations">
          <tr class="bg-200 o_line_section">
            <td colspan="5">
              <strong>Parts</strong>
            </td>
          </tr>
          <tr t-foreach="o.operations" t-as="line">
            <td>
              <p t-if="line.type == 'add'">
                <i>(Add)</i>
                <span t-field="line.name" />
              </p>
              <p t-if="line.type == 'remove'">(<i>Remove</i>) <span t-field="line.name" /></p>
            </td>
            <td class="text-end">
              <span t-field="line.product_uom_qty" />
              <span groups="uom.group_uom" t-field="line.product_uom.name" />
            </td>
            <t t-if="(line.repair_id.invoice_method != 'none')">
              <td class="text-end">
                <span t-field="line.price_unit" />
              </td>
              <td class="text-center">
                <span t-esc="','.join(map( lambda x: x.description or x.name, line.tax_id))" />
              </td>
              <td class="text-end o_price_total">
                <span t-field="line.price_subtotal"
                  t-options='{"widget": "monetary", "display_currency": o.pricelist_id.currency_id}' />
              </td>
            </t>
          </tr>
        </t>
        <t t-if="o.fees_lines">
          <tr class="bg-200 o_line_section">
            <td colspan="5">
              <strong>Operations</strong>
            </td>
          </tr>
          <tr t-foreach="o.fees_lines" t-as="fees">
            <td>
              <span t-field="fees.name" />
            </td>
            <td class="text-end">
              <span t-field="fees.product_uom_qty" />
              <span groups="uom.group_uom" t-field="fees.product_uom.name" />
            </td>
            <t t-if="(fees.repair_id.invoice_method != 'none')">
              <td class="text-end">
                <span t-field="fees.price_unit" />
              </td>
              <td class="text-center">
                <span t-esc="','.join(map( lambda x: x.description or x.name, fees.tax_id))" />
              </td>
              <td class="text-end o_price_total">
                <span t-field="fees.price_subtotal"
                  t-options='{"widget": "monetary", "display_currency": o.pricelist_id.currency_id}' />
              </td>
            </t>
          </tr>
        </t>
      </tbody>
  </table>
  </template>

</odoo>
